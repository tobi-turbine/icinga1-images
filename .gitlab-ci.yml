variables:
  BASE_IMAGE: registry.suchgenie.de/icinga-extended
  BUILD_ICINGA_CONFIGURED_TOKEN: 12a58a444cc49e3249faa6d2e554a8
  BUILD_ICINGA_CONFIGURED_ID: "4"

stages:
  - build
  - tag
  - postHook

build-image:
  stage: build
  script:
    - git submodule init && git submodule update
    - docker build --pull=true -t $BASE_IMAGE:$CI_BUILD_REF .
    - docker push $BASE_IMAGE:$CI_BUILD_REF

tag-build:
  stage: tag
  script:
    - docker pull $BASE_IMAGE:$CI_BUILD_REF
    - if [ "$CI_BUILD_REF_NAME" == "master" ]; then TAG_NAME="latest"; else TAG_NAME="$CI_BUILD_REF_NAME"; fi
    - docker tag -f $BASE_IMAGE:$CI_BUILD_REF $BASE_IMAGE:$TAG_NAME
    - docker push $BASE_IMAGE:$TAG_NAME

trigger-icinga-extended:
  stage: postHook
  script:
    - "curl -X POST -F token=$BUILD_ICINGA_CONFIGURED_TOKEN https://gitlab.suchgenie.de/ci/api/v1/projects/$BUILD_ICINGA_CONFIGURED_ID/refs/$CI_BUILD_REF_NAME/trigger"
